#!/usr/bin/env python3

import argparse
import subprocess
import sys

import jinja2
import path


def generate_script(cmd=None, browser=None, url=None):
    this_dir = path.Path(__file__).parent.abspath()
    template_path = path.Path(this_dir.joinpath("on-nvim-refresh.jinja.py"))
    env = jinja2.Environment(trim_blocks=True, lstrip_blocks=True, keep_trailing_newline=True)
    template = env.from_string(template_path.text())
    out_path = path.Path("on-nvim-refresh.py")
    out_path.write_text(template.render(locals()))


def run_script():
    out_path = path.Path("on-nvim-refresh.py")
    subprocess.run([sys.executable, out_path])


def sanitize_url(url):
    as_path = path.Path(url)
    if as_path.exists():
        url = "file://" + as_path.abspath()
    return url


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--browser", choices=["chrome", "firefox"])
    parser.add_argument("--cmd")
    parser.add_argument("--url")
    args = parser.parse_args()
    url = args.url
    if args.browser and not url:
        sys.exit("--browser used but no url set")
    if url:
        url = sanitize_url(url)
    generate_script(cmd=args.cmd, browser=args.browser, url=url)
    run_script()


if __name__ == "__main__":
    main()
